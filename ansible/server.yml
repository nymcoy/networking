---
- name: Configure server
  hosts: server
  become: yes
  vars_files:
    - psk.yml
  tasks:
    - name: Update and dist-upgrade apt packages
      apt:
        update_cache: yes
        upgrade: dist
      when: false

    - name: Delete existing default route
      command: ip route del default
      ignore_errors: yes

    - name: Add default route to router
      command: ip route add default via 192.168.10.1

    - name: Install StrongSwan
      apt:
        name: strongswan
        state: present

    - name: Install Nginx
      apt:
        name: nginx
        state: present

    - name: Create a simple HTML page
      copy:
        content: |
          <html>
          <head>
              <title>Welcome to the Server</title>
          </head>
          <body>
              <h1>Hello from the Server!</h1>
          </body>
          </html>
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: '0644'

    - name: Start and enable Nginx
      systemd:
        name: nginx
        enabled: yes
        state: started

    - name: Configure StrongSwan with ipsec.conf
      copy:
        content: |
          config setup
            # charondebug="ike 3, knl 1, cfg 3"
            charondebug="cfg 4, dmn 4, ike 4, net 4"
            uniqueids=replace

          conn gateway-to-server
            auto=add
            compress=no
            type=tunnel
            keyexchange=ikev2
            fragmentation=yes
            forceencaps=yes
            dpdaction=clear
            dpddelay=30s
            dpdtimeout=180s
            rekey=yes
            authby=secret
            ike=aes256gcm12-sha256-modp4096,aes128gcm12-sha256-modp4096!
            esp=aes256gcm12-sha256,aes128gcm12-sha256!
            right=192.168.20.2
            rightid=@gateway
            rightsubnet=192.168.20.0/24
            # rightsourceip=%config
            left=%any
            leftid=@server
            leftsourceip=%config
            mobike=no
        dest: /etc/ipsec.conf
        owner: root
        group: root
        mode: '0644'

    - name: Configure IPsec secrets
      copy:
        content: |
          @server @gateway : PSK "{{ vpn_psk }}"
        dest: /etc/ipsec.secrets
        owner: root
        group: root
        mode: '0600'

    - name: Restart StrongSwan service
      systemd:
        name: strongswan
        enabled: yes
        state: restarted

    - name: Provision complete
      debug:
        msg: "Server machine (StrongSwan VPN client and Nginx web server) provisioned."
